import React, { useState, useEffect, useRef } from 'react';
import { 
  Plus, 
  Trash2, 
  Save, 
  X, 
  Music, 
  Disc, 
  Info,
  ChevronLeft,
  ChevronRight,
  Lock,
  Upload,
  Loader2,
  ShoppingBag,
  ExternalLink,
  Image as ImageIcon,
  Wand2,
  Scissors,
  FileUp,
  Palette, 
  ImagePlus,
  Zap, 
  Droplet // Icon for "Clear/Transparent"
} from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInWithCustomToken, 
  signInAnonymously, 
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  doc, 
  addDoc, 
  updateDoc, 
  deleteDoc, 
  onSnapshot, 
  query, 
} from 'firebase/firestore';

// --- Firebase Configuration & Initialization ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- Gemini API Configuration ---
const apiKey = ""; // The execution environment provides the key at runtime.

// --- Default Data for Demo ---
const DEMO_ALBUMS = [
  {
    title: "Dark Side of the Moon",
    artist: "Pink Floyd",
    year: "1973",
    genre: "Rock",
    coverUrl: "https://upload.wikimedia.org/wikipedia/en/3/3b/Dark_Side_of_the_Moon.png",
    vinylColor: "transparent"
  },
  {
    title: "Abbey Road",
    artist: "The Beatles",
    year: "1969",
    genre: "Rock",
    coverUrl: "https://upload.wikimedia.org/wikipedia/en/4/42/Beatles_-_Abbey_Road.jpg",
    vinylColor: "transparent"
  },
  {
    title: "Thriller",
    artist: "Michael Jackson",
    year: "1982",
    genre: "Pop",
    coverUrl: "https://upload.wikimedia.org/wikipedia/en/5/55/Michael_Jackson_-_Thriller.png",
    vinylColor: "transparent"
  },
  {
    title: "Rumours",
    artist: "Fleetwood Mac",
    year: "1977",
    genre: "Rock",
    coverUrl: "https://upload.wikimedia.org/wikipedia/en/f/fb/FMacRumours.PNG",
    vinylColor: "transparent"
  },
  {
    title: "Purple Rain",
    artist: "Prince",
    year: "1984",
    genre: "Pop",
    coverUrl: "https://upload.wikimedia.org/wikipedia/en/9/9c/Prince_Purple_Rain.jpg",
    vinylColor: "#800080"
  }
];

// --- Utility: Image Compression & Smart Shadow Removal ---
const compressAndCropImage = (dataUrl, targetSize = 600, quality = 0.8) => {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);

      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const pixels = imageData.data;
      
      let minX = canvas.width, minY = canvas.height, maxX = 0, maxY = 0;
      let hasContent = false;

      // Smart Shadow Detection Thresholds
      const shadowThreshold = 220; 

      for (let y = 0; y < canvas.height; y++) {
        for (let x = 0; x < canvas.width; x++) {
          const i = (y * canvas.width + x) * 4;
          const r = pixels[i];
          const g = pixels[i + 1];
          const b = pixels[i + 2];
          const a = pixels[i + 3];

          if (a < 50) continue;

          const isWhiteOrShadow = r > shadowThreshold && g > shadowThreshold && b > shadowThreshold;
          
          if (!isWhiteOrShadow) {
            minX = Math.min(minX, x);
            minY = Math.min(minY, y);
            maxX = Math.max(maxX, x);
            maxY = Math.max(maxY, y);
            hasContent = true;
          }
        }
      }

      let croppedX = minX;
      let croppedY = minY;
      let croppedWidth = maxX - minX;
      let croppedHeight = maxY - minY;

      if (!hasContent || croppedWidth <= 0 || croppedHeight <= 0) {
         const size = Math.min(canvas.width, canvas.height);
         croppedX = (canvas.width - size) / 2;
         croppedY = (canvas.height - size) / 2;
         croppedWidth = size;
         croppedHeight = size;
      } else {
        const size = Math.max(croppedWidth, croppedHeight);
        const centerX = minX + croppedWidth / 2;
        const centerY = minY + croppedHeight / 2;
        
        croppedX = centerX - size / 2;
        croppedY = centerY - size / 2;
        croppedWidth = size;
        croppedHeight = size;
      }

      if (croppedX < 0) { croppedWidth += croppedX; croppedX = 0; }
      if (croppedY < 0) { croppedHeight += croppedY; croppedY = 0; }
      if (croppedX + croppedWidth > canvas.width) { croppedWidth = canvas.width - croppedX; }
      if (croppedY + croppedHeight > canvas.height) { croppedHeight = canvas.height - croppedY; }

      const finalCanvas = document.createElement('canvas');
      const finalCtx = finalCanvas.getContext('2d');
      finalCanvas.width = targetSize;
      finalCanvas.height = targetSize;

      finalCtx.drawImage(
        img, 
        croppedX, croppedY, croppedWidth, croppedHeight, 
        0, 0, targetSize, targetSize
      );

      resolve(finalCanvas.toDataURL('image/jpeg', quality));
    };
    img.onerror = () => reject(new Error("Image loading failed."));
    img.src = dataUrl;
  });
};

// --- Utility: Standard Image Compression (No Cropping) ---
const compressImage = (dataUrl, maxWidth = 600, quality = 0.7) => {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      let width = img.width;
      let height = img.height;

      if (width > height) {
        if (width > maxWidth) {
          height *= maxWidth / width;
          width = maxWidth;
        }
      } else {
        if (height > maxWidth) {
          width *= maxWidth / height;
          height = maxWidth;
        }
      }

      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);
      resolve(canvas.toDataURL('image/jpeg', quality));
    };
    img.src = dataUrl;
  });
};


// --- Visual Components ---

const VinylRecordVisual = ({ coverUrl, vinylUrl, isSpinning, color = "#111111" }) => {
  // 1. Custom/Generated Image (Full Bleed)
  if (vinylUrl) {
    return (
      <div className={`relative w-full h-full rounded-full shadow-2xl flex items-center justify-center overflow-hidden ${isSpinning ? 'animate-spin-slow' : ''}`}
           style={{
             boxShadow: 'inset 0 0 20px rgba(0,0,0,0.6)',
             backgroundColor: '#111', 
             backgroundImage: `url(${vinylUrl})`,
             backgroundSize: 'cover',
             backgroundPosition: 'center',
             backgroundRepeat: 'no-repeat'
           }}>
        {/* Center Hole - Explicitly Centered */}
        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-3 h-3 bg-[#e5e5e5] rounded-full z-20 border border-gray-400 shadow-inner" />
      </div>
    );
  }

  // 2. Transparent / Clear Vinyl Logic
  if (color === 'transparent') {
    return (
      <div className={`relative w-full h-full rounded-full shadow-xl flex items-center justify-center ${isSpinning ? 'animate-spin-slow' : ''}`}
           style={{
             backgroundColor: 'rgba(255, 255, 255, 0.15)', // Milky white base
             backdropFilter: 'blur(2px)', // Glass/Plastic effect
             boxShadow: 'inset 0 0 10px rgba(0,0,0,0.2), 0 4px 10px rgba(0,0,0,0.1)'
           }}>
        {/* Grooves (Subtle for Clear Vinyl) */}
        <div className="absolute inset-0 rounded-full opacity-40" 
             style={{
               background: `repeating-radial-gradient(
                 rgba(0,0,0,0.05) 0, 
                 rgba(0,0,0,0.05) 1px, 
                 transparent 2px, 
                 transparent 3px
               )`
             }} 
        />
        {/* Shine */}
        <div className="absolute inset-0 rounded-full opacity-30 bg-gradient-to-tr from-white/40 to-transparent pointer-events-none" />
        
        {/* Label */}
        <div className="w-[38%] h-[38%] rounded-full overflow-hidden border border-white/10 relative z-10 bg-gray-900 shadow-md">
          {coverUrl && (
            <img src={coverUrl} alt="label" className="w-full h-full object-cover" />
          )}
        </div>
        {/* Center Hole - Explicitly Centered */}
        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-3 h-3 bg-[#e5e5e5] rounded-full z-20 border border-gray-400 shadow-inner" />
      </div>
    );
  }

  // 3. Standard Solid Color Fallback
  return (
    <div className={`relative w-full h-full rounded-full shadow-2xl flex items-center justify-center ${isSpinning ? 'animate-spin-slow' : ''}`}
         style={{
           backgroundColor: color,
           background: `radial-gradient(circle, ${color} 0%, ${color} 100%)`, 
           boxShadow: 'inset 0 0 20px rgba(0,0,0,0.6)'
         }}>
      <div className="absolute inset-0 rounded-full opacity-30" 
           style={{
             background: `repeating-radial-gradient(
               #000 0, 
               #000 1px, 
               transparent 2px, 
               transparent 3px
             )`
           }} 
      />
      <div className="absolute inset-0 rounded-full opacity-20 bg-gradient-to-tr from-white/30 to-transparent pointer-events-none" />
      <div className="w-[38%] h-[38%] rounded-full overflow-hidden border border-white/10 relative z-10 bg-gray-900 shadow-md">
        {coverUrl && (
          <img src={coverUrl} alt="label" className="w-full h-full object-cover" />
        )}
      </div>
      {/* Center Hole - Explicitly Centered */}
      <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-3 h-3 bg-[#e5e5e5] rounded-full z-20 border border-gray-400 shadow-inner" />
    </div>
  );
};

const Modal = ({ isOpen, onClose, title, children }) => {
  if (!isOpen) return null;
  
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-in fade-in duration-200 apple-font">
      <div className="bg-white border border-gray-200 rounded-xl w-full max-w-lg overflow-hidden animate-in zoom-in-95 duration-200 shadow-2xl flex flex-col max-h-[90vh]">
        <div className="flex justify-between items-center p-4 border-b border-gray-100 bg-gray-50 flex-shrink-0">
          <h3 className="text-lg font-thin text-gray-900">{title}</h3>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-900 transition-colors">
            <X size={20} />
          </button>
        </div>
        <div className="p-6 overflow-y-auto">
          {children}
        </div>
      </div>
    </div>
  );
};

export default function App() {
  const [user, setUser] = useState(null);
  const [albums, setAlbums] = useState([]);
  const [loading, setLoading] = useState(true);
  const [selectedIndex, setSelectedIndex] = useState(0);
  
  // Modal States
  const [isEditModalOpen, setIsEditModalOpen] = useState(false);
  const [isAddModalOpen, setIsAddModalOpen] = useState(false);
  const [editingAlbum, setEditingAlbum] = useState(null);
  const [isDesignMode, setIsDesignMode] = useState(false);
  
  // Auth & Password States
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [isPasswordModalOpen, setIsPasswordModalOpen] = useState(false);
  const [passwordAttempt, setPasswordAttempt] = useState('');
  const [pendingAction, setPendingAction] = useState(null);

  // Search/Fetch State
  const [isFetching, setIsFetching] = useState(false);
  const [isProcessingVinyl, setIsProcessingVinyl] = useState(false);

  // Drag States
  const [dragActiveField, setDragActiveField] = useState(null);

  // Form State
  const [formData, setFormData] = useState({
    title: '',
    artist: '',
    year: '',
    genre: '',
    coverUrl: '',
    vinylUrl: '', 
    vinylColor: 'transparent' // Default to transparent
  });

  // --- Auth & Data Fetching ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Auth failed", error);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user) return;

    const collectionRef = collection(db, 'artifacts', appId, 'users', user.uid, 'vinyls');
    const q = query(collectionRef);

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const loadedAlbums = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      })).sort((a, b) => a.artist.localeCompare(b.artist)); 

      setAlbums(loadedAlbums);
      setLoading(false);
      
      if (selectedIndex >= loadedAlbums.length && loadedAlbums.length > 0) {
        setSelectedIndex(loadedAlbums.length - 1);
      }
    }, (error) => {
      console.error("Firestore Error:", error);
      setLoading(false);
    });

    return () => unsubscribe();
  }, [user, selectedIndex]);

  // --- Handlers ---

  const handleScroll = (e) => {
    if (Math.abs(e.deltaY) > 10) {
      if (e.deltaY > 0) {
        nextAlbum();
      } else {
        prevAlbum();
      }
    }
  };

  const nextAlbum = () => {
    setSelectedIndex(prev => Math.min(prev + 1, albums.length - 1));
  };

  const prevAlbum = () => {
    setSelectedIndex(prev => Math.max(prev - 1, 0));
  };

  useEffect(() => {
    const handleKeyDown = (e) => {
      if (isAddModalOpen || isEditModalOpen || isPasswordModalOpen) return;
      if (e.key === 'ArrowRight') nextAlbum();
      if (e.key === 'ArrowLeft') prevAlbum();
    };
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [albums, isAddModalOpen, isEditModalOpen, isPasswordModalOpen]);

  // --- Nano Banana AI Logic (Gemini + Imagen) ---

  const callGeminiAPI = async (url, payload) => {
    let retries = 0;
    const maxRetries = 3;
    const baseDelay = 1000;

    while (retries <= maxRetries) {
      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error(`API Error: ${response.status}`);
        }
        return await response.json();
      } catch (error) {
        if (retries === maxRetries) throw error;
        retries++;
        await new Promise(resolve => setTimeout(resolve, baseDelay * Math.pow(2, retries)));
      }
    }
  };

  const generateVinylImageWithAI = async (promptDescription) => {
    try {
      setIsProcessingVinyl(true);
      const generationUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;
      const generationPayload = {
        instances: [{
          prompt: `${promptDescription}. The record should be a perfect circle, with realistic groove texture, top-down view. High resolution, photorealistic, isolated on a pure white background.`
        }],
        parameters: { sampleCount: 1 }
      };

      const generationResult = await callGeminiAPI(generationUrl, generationPayload);
      const generatedBase64 = generationResult.predictions?.[0]?.bytesBase64Encoded;

      if (generatedBase64) {
        const fullDataUrl = `data:image/png;base64,${generatedBase64}`;
        // Use the enhanced compressAndCropImage which detects and removes shadows
        return await compressAndCropImage(fullDataUrl, 600, 0.7); 
      }
      throw new Error("Failed to generate image");

    } catch (error) {
      console.error("Nano Banana AI Generation Error:", error);
      alert("Nano Banana AI could not generate the vinyl. Please try a different input.");
      return null;
    } finally {
      setIsProcessingVinyl(false);
    }
  };

  const processPatternWithNanoBanana = async (patternImgBase64) => {
    try {
      setIsProcessingVinyl(true);
      // 1. Analyze pattern
      const base64Data = patternImgBase64.split(',')[1];
      const analysisUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
      const analysisPayload = {
        contents: [{
          parts: [
            { text: "Describe the colors, texture, and style of this pattern in 15 words or less. Focus on the visual aesthetics." },
            { inlineData: { mimeType: "image/jpeg", data: base64Data } }
          ]
        }]
      };

      const analysisResult = await callGeminiAPI(analysisUrl, analysisPayload);
      const description = analysisResult.candidates?.[0]?.content?.parts?.[0]?.text || "abstract pattern";

      // 2. Generate vinyl
      const vinylDataUrl = await generateVinylImageWithAI(`A photorealistic vinyl record disc texture featuring this style: ${description}`);
      
      if (vinylDataUrl) {
        setFormData(prev => ({
          ...prev,
          vinylUrl: vinylDataUrl,
          vinylColor: '#111111' 
        }));
      }

    } catch (error) {
      console.error("Nano Banana Pattern Processing Error:", error);
      alert("Nano Banana AI could not process the vinyl pattern.");
    } finally {
      setIsProcessingVinyl(false);
    }
  };

  const handleSolidColorGeneration = async (colorHex) => {
    setFormData(prev => ({ ...prev, vinylColor: colorHex })); 
    const vinylDataUrl = await generateVinylImageWithAI(`A perfect flat scan of a solid color vinyl record disc in the exact color hex ${colorHex}. Visible grooves. No background. Full frame.`);
    if (vinylDataUrl) {
      setFormData(prev => ({
        ...prev,
        vinylUrl: vinylDataUrl,
        vinylColor: colorHex
      }));
    }
  };

  // --- File Handling ---

  const processFile = async (file, field) => {
    if (!file) return;
    
    if (file.size > 5 * 1024 * 1024) {
      alert(`File is too large. Limit is 5MB.`);
      return;
    }

    if (field === 'composite') {
      processCompositeImage(file);
      return;
    }

    const reader = new FileReader();
    reader.onloadend = async (e) => {
      const result = e.target.result;
      let compressedResult;
      if (field === 'vinylUrl') {
        compressedResult = await compressAndCropImage(result, 500, 0.6);
      } else {
        compressedResult = await compressImage(result, field === 'coverUrl' ? 600 : 500, 0.6);
      }
      setFormData(prev => ({ ...prev, [field]: compressedResult }));
    };
    reader.readAsDataURL(file);
  };

  const handlePatternUpload = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = async (event) => {
      const result = event.target.result;
      const compressedPattern = await compressImage(result, 400, 0.6); 
      await processPatternWithNanoBanana(compressedPattern);
    };
    reader.readAsDataURL(file);
  };

  const handleFileChange = (e, field) => {
    const file = e.target.files[0];
    processFile(file, field);
  };

  const handleCompositeUpload = (e) => {
    const file = e.target.files[0];
    processFile(file, 'composite');
  };

  const clearImage = (field) => {
    setFormData(prev => {
      const updates = { [field]: '' };
      if (field === 'vinylUrl') {
        updates.vinylColor = '#111111';
      }
      return { ...prev, ...updates };
    });
  };

  const handleDrag = (e, field) => {
    e.preventDefault();
    e.stopPropagation();
    if (e.type === "dragenter" || e.type === "dragover") {
      setDragActiveField(field);
    } else if (e.type === "dragleave") {
      setDragActiveField(null);
    }
  };

  const handleDrop = (e, field) => {
    e.preventDefault();
    e.stopPropagation();
    setDragActiveField(null);
    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
      processFile(e.dataTransfer.files[0], field);
    }
  };

  const processCompositeImage = (file) => {
    const reader = new FileReader();
    reader.onload = (event) => {
      const img = new Image();
      img.onload = async () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        const totalWidth = img.width;
        const totalHeight = img.height;
        const splitX = Math.floor(totalWidth / 2);

        // 1. Extract Cover (Left Half)
        const coverSize = Math.min(splitX, totalHeight);
        canvas.width = coverSize;
        canvas.height = coverSize;
        
        ctx.drawImage(img, 0, 0, splitX, totalHeight, 0, 0, coverSize, coverSize);
        const coverDataUrl = canvas.toDataURL('image/jpeg', 0.6);

        // 2. Extract Vinyl (Right Half)
        const rightHalfCanvas = document.createElement('canvas');
        rightHalfCanvas.width = coverSize;
        rightHalfCanvas.height = coverSize;
        const rctx = rightHalfCanvas.getContext('2d');
        
        const rightHalfWidth = totalWidth - splitX;
        rctx.drawImage(img, splitX, 0, rightHalfWidth, totalHeight, 0, 0, coverSize, coverSize);
        
        const vinylSourceData = rightHalfCanvas.toDataURL('image/jpeg', 0.6);
        
        const finalCoverData = await compressImage(coverDataUrl, 500, 0.6);
        const finalVinylData = await compressAndCropImage(vinylSourceData, 500, 0.6);

        setFormData(prev => ({
          ...prev,
          coverUrl: finalCoverData,
          vinylUrl: finalVinylData,
          vinylColor: '#111111'
        }));
      };
      img.src = event.target.result;
    };
    reader.readAsDataURL(file);
  };

  // --- iTunes Search Logic ---
  const searchiTunesMetadata = async () => {
    if (!formData.artist || !formData.title) {
        alert("Please enter an Artist and Album Title to search.");
        return;
    }
    setIsFetching(true);
    try {
      const query = encodeURIComponent(`${formData.artist} ${formData.title}`);
      const response = await fetch(`https://itunes.apple.com/search?term=${query}&entity=album&limit=1`);
      const data = await response.json();

      if (data.resultCount > 0) {
        const result = data.results[0];
        const highResCover = result.artworkUrl100 ? result.artworkUrl100.replace('100x100bb', '600x600bb') : '';
        
        setFormData(prev => ({
          ...prev,
          title: result.collectionName, 
          artist: result.artistName,
          year: result.releaseDate ? result.releaseDate.substring(0, 4) : prev.year,
          genre: result.primaryGenreName || prev.genre,
          coverUrl: highResCover || prev.coverUrl 
        }));
      } else {
        alert("No details found on iTunes.");
      }
    } catch (error) {
      console.error("iTunes Search Error", error);
      alert("Failed to fetch details.");
    } finally {
      setIsFetching(false);
    }
  };

  const handleSave = async (e) => {
    e.preventDefault();
    if (!user) return;
    
    const payloadSize = JSON.stringify(formData).length;
    if (payloadSize > 1000000) {
        alert("Data is too large. Please use smaller images or compress them further.");
        return;
    }

    const collectionRef = collection(db, 'artifacts', appId, 'users', user.uid, 'vinyls');

    try {
      if (editingAlbum) {
        await updateDoc(doc(collectionRef, editingAlbum.id), formData);
      } else {
        await addDoc(collectionRef, {
          ...formData,
          createdAt: Date.now()
        });
      }
      closeModals();
    } catch (error) {
      console.error("Error saving:", error);
      alert("Error saving. Images might be too large.");
    }
  };

  const handleDelete = async () => {
    if (!user || !editingAlbum) return;
    if (confirm('Are you sure you want to remove this album from your collection?')) {
      try {
        await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'vinyls', editingAlbum.id));
        closeModals();
        setSelectedIndex(prev => Math.max(0, prev - 1));
      } catch (error) {
        console.error("Error deleting:", error);
      }
    }
  };

  // --- Password Logic ---

  const checkAuthAndExecute = (action) => {
    if (isAuthenticated) {
      executeAction(action);
    } else {
      setPendingAction(action);
      setIsPasswordModalOpen(true);
      setPasswordAttempt('');
    }
  };

  const executeAction = (action) => {
    if (action.type === 'add') {
      setFormData({ 
        title: '', 
        artist: '', 
        year: '', 
        genre: '', 
        coverUrl: '', 
        vinylUrl: '',
        vinylColor: 'transparent',
        rawPatternUrl: ''
      });
      setEditingAlbum(null);
      setIsDesignMode(false);
      setIsAddModalOpen(true);
    } else if (action.type === 'edit') {
      const album = action.album;
      setFormData({ 
        title: album.title, 
        artist: album.artist, 
        year: album.year || '', 
        genre: album.genre || '',
        coverUrl: album.coverUrl || '',
        vinylUrl: album.vinylUrl || '',
        vinylColor: album.vinylColor || 'transparent',
        rawPatternUrl: album.rawPatternUrl || ''
      });
      setEditingAlbum(album);
      setIsDesignMode(false);
      setIsEditModalOpen(true);
    }
  };

  const handlePasswordSubmit = (e) => {
    e.preventDefault();
    if (passwordAttempt === 'Andwwy') {
      setIsAuthenticated(true);
      setIsPasswordModalOpen(false);
      if (pendingAction) {
        executeAction(pendingAction);
        setPendingAction(null);
      }
    } else {
      alert("Incorrect password");
      setPasswordAttempt('');
    }
  };

  const openAddModal = () => {
    checkAuthAndExecute({ type: 'add' });
  };

  const openEditModal = (album) => {
    checkAuthAndExecute({ type: 'edit', album });
  };

  const closeModals = () => {
    setIsAddModalOpen(false);
    setIsEditModalOpen(false);
    setIsPasswordModalOpen(false);
    setEditingAlbum(null);
    setPendingAction(null);
    setIsDesignMode(false);
    setIsAuthenticated(false); // Reset auth on close
  };

  const seedDemoData = async () => {
    if (!user) return;
    const collectionRef = collection(db, 'artifacts', appId, 'users', user.uid, 'vinyls');
    setLoading(true);
    for (const album of DEMO_ALBUMS) {
      await addDoc(collectionRef, { ...album, createdAt: Date.now() });
    }
    setLoading(false);
  };

  const openVinylDotCom = (artist, title) => {
    const query = encodeURIComponent(`${artist} ${title} vinyl`);
    window.open(`https://vinyl.com/search?q=${query}`, '_blank');
  };

  // --- Rendering Helpers ---

  const getCoverStyle = (index) => {
    const diff = index - selectedIndex;
    const isSelected = diff === 0;
    
    const xSpacing = 60; 
    const zDepth = -250; 
    const rotation = 55; 
    
    let transform = '';
    let zIndex = 0;
    let opacity = 1;
    
    if (isSelected) {
      transform = `translate3d(0, 0, 100px) rotateY(0deg)`;
      zIndex = 100;
      opacity = 1;
    } else if (diff < 0) {
      transform = `translate3d(${-40 + (diff * 40)}px, 0, ${zDepth}px) rotateY(${rotation}deg)`;
      zIndex = 10 + diff;
      opacity = Math.max(0.3, 1 + (diff * 0.15));
    } else {
      transform = `translate3d(${40 + (diff * 40)}px, 0, ${zDepth}px) rotateY(${-rotation}deg)`;
      zIndex = 10 - diff;
      opacity = Math.max(0.3, 1 - (diff * 0.15));
    }

    return {
      transform,
      zIndex,
      opacity,
      transition: 'all 0.4s cubic-bezier(0.25, 1, 0.5, 1)'
    };
  };

  const activeAlbum = albums[selectedIndex];

  if (loading && albums.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center h-screen bg-white text-black apple-font">
        <div className="animate-spin mb-4"><Disc size={40} className="text-gray-400" /></div>
        <p className="text-gray-500 font-thin">Loading your library...</p>
      </div>
    );
  }

  return (
    <div className="relative h-screen bg-white text-black overflow-hidden select-none apple-font font-thin">
      
      {/* Background */}
      <div className="absolute inset-0 bg-gradient-to-b from-gray-50 via-white to-gray-50 -z-10" />

      {/* Floating Header */}
      <div className="absolute top-0 left-0 p-6 z-30 pointer-events-none">
        <div className="pointer-events-auto flex flex-col items-start">
          <div className="flex items-center space-x-2 text-gray-900 mb-1">
             <Music size={18} className="text-gray-400" />
             <span className="font-thin text-sm tracking-wide">Andwwy Collection</span>
          </div>
          <div className="text-xs text-gray-400 font-thin tracking-wide pl-7">
             {albums.length > 0 ? `${selectedIndex + 1} of ${albums.length}` : 'Empty'}
          </div>
        </div>
      </div>

      {/* Floating Add Button */}
      <div className="absolute top-0 right-0 p-6 z-30 pointer-events-none">
         <button 
           onClick={openAddModal}
           className="pointer-events-auto bg-gray-100/50 hover:bg-gray-100 text-gray-500 p-2.5 rounded-full transition-all backdrop-blur-sm"
           title="Add Album"
         >
           <Plus size={20} />
         </button>
      </div>

      {/* Main Cover Flow Area */}
      <div 
        className="absolute inset-0 flex items-center justify-center perspective-container z-10"
        onWheel={handleScroll}
        style={{ perspective: '1000px' }}
      >
        
        {albums.length === 0 ? (
          <div className="text-center space-y-6 z-10 animate-in fade-in zoom-in duration-500">
            <div className="w-48 h-48 mx-auto bg-gray-50 border-2 border-dashed border-gray-200 rounded-2xl flex items-center justify-center">
              <Disc size={48} className="text-gray-300" />
            </div>
            <div>
              <h2 className="text-xl font-thin text-gray-800">No Music Found</h2>
              <p className="text-gray-500 text-sm mt-1 font-thin">Your collection is empty.</p>
            </div>
            <button 
              onClick={seedDemoData}
              className="px-6 py-2.5 bg-blue-500 hover:bg-blue-600 text-white rounded-full text-sm font-thin transition-transform active:scale-95 shadow-lg shadow-blue-500/30"
            >
              Load Demo Collection
            </button>
          </div>
        ) : (
          <div className="relative w-full h-[320px] md:h-[400px] flex items-center justify-center transform-style-3d">
             {albums.map((album, index) => {
                if (Math.abs(selectedIndex - index) > 6) return null;
                
                const style = getCoverStyle(index);
                const isSelected = index === selectedIndex;
                
                return (
                  <div
                    key={album.id}
                    className="absolute w-48 h-48 md:w-64 md:h-64 top-1/2 left-1/2 -mt-24 -ml-24 md:-mt-32 md:-ml-32 cursor-pointer group"
                    style={style}
                    onClick={() => setSelectedIndex(index)}
                  >
                    {/* Vinyl Record Slide-Out Effect */}
                    {isSelected && (
                      <div className="absolute inset-0 z-[-1] transition-transform duration-700 ease-out group-hover:translate-x-[45%] flex items-center justify-center">
                        <div className="w-[90%] h-[90%]">
                          <VinylRecordVisual 
                            coverUrl={album.coverUrl} 
                            vinylUrl={album.vinylUrl}
                            isSpinning={true} 
                            color={album.vinylColor || '#111111'}
                          />
                        </div>
                      </div>
                    )}

                    {/* Album Cover */}
                    <div className="relative w-full h-full bg-white rounded-sm overflow-hidden shadow-none">
                      <img 
                        src={album.coverUrl || "/api/placeholder/400/400"} 
                        alt={album.title}
                        className="w-full h-full object-cover select-none"
                        onError={(e) => { e.target.src = "https://placehold.co/400x400/f3f4f6/9ca3af?text=No+Cover"; }}
                      />
                      <div className="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent pointer-events-none"></div>
                    </div>
                  </div>
                );
             })}
          </div>
        )}
      </div>

      {/* Floating Bottom Info */}
      <div className="absolute bottom-0 left-0 right-0 pb-16 pt-8 flex flex-col items-center justify-center z-30 pointer-events-none">
        {activeAlbum ? (
          <div className="text-center space-y-2 pointer-events-auto animate-in slide-in-from-bottom-4 duration-300 max-w-lg px-6">
            <h1 className="text-lg md:text-xl font-thin text-gray-900 tracking-tight leading-none">
              {activeAlbum.title}
            </h1>
            <h2 className="text-xs md:text-sm text-gray-500 font-thin tracking-tight">
              {activeAlbum.artist}
            </h2>
            
             <div className="flex items-center justify-center gap-3 mt-4 opacity-70 hover:opacity-100 transition-opacity">
                {activeAlbum.genre && (
                    <>
                    <span className="text-xs text-gray-400 font-thin">
                        {activeAlbum.genre}
                    </span>
                    <span className="text-gray-300 font-thin">•</span>
                    </>
                )}
                <span className="text-xs text-gray-400 font-thin">
                  {activeAlbum.year}
                </span>
                <span className="text-gray-300 font-thin">•</span>
                <button 
                    onClick={() => openEditModal(activeAlbum)}
                    className="text-xs text-gray-400 hover:text-blue-500 transition-colors flex items-center gap-1 font-thin"
                    title="Edit"
                >
                  <Info size={12} />
                </button>
                <span className="text-gray-300 font-thin">•</span>
                <button 
                    onClick={() => openVinylDotCom(activeAlbum.artist, activeAlbum.title)}
                    className="text-xs text-gray-400 hover:text-blue-500 transition-colors flex items-center gap-1 font-thin group"
                    title="Buy on Vinyl.com"
                >
                  Shop <ExternalLink size={10} className="opacity-50 group-hover:opacity-100" />
                </button>
             </div>
          </div>
        ) : (
          <div className="text-gray-400 text-sm font-thin">Select an album</div>
        )}
      </div>

      {/* Mobile Navigation */}
      <div className="md:hidden flex justify-between px-4 absolute top-1/2 -translate-y-1/2 w-full z-20 pointer-events-none">
          <button onClick={prevAlbum} className="pointer-events-auto p-4 text-gray-300 hover:text-gray-600 transition-colors"><ChevronLeft size={32}/></button>
          <button onClick={nextAlbum} className="pointer-events-auto p-4 text-gray-300 hover:text-gray-600 transition-colors"><ChevronRight size={32}/></button>
      </div>

      {/* Password Modal */}
      <Modal 
        isOpen={isPasswordModalOpen} 
        onClose={closeModals}
        title="Admin Access"
      >
        <form onSubmit={handlePasswordSubmit} className="space-y-4">
           <div className="flex flex-col items-center justify-center py-4 space-y-4">
              <div className="bg-gray-50 p-3 rounded-full">
                 <Lock size={24} className="text-gray-400" />
              </div>
              <p className="text-xs text-center text-gray-500 font-thin">Please enter password to modify collection.</p>
           </div>
           
           <div>
            <input 
              type="password" 
              autoFocus
              value={passwordAttempt}
              onChange={(e) => setPasswordAttempt(e.target.value)}
              className="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5 text-gray-900 text-center focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all font-thin tracking-widest"
              placeholder="••••••"
            />
          </div>

          <div className="flex items-center gap-3 pt-2">
            <button 
              type="button"
              onClick={closeModals}
              className="flex-1 px-4 py-2.5 text-gray-500 hover:bg-gray-50 rounded-lg font-thin transition-colors"
            >
              Cancel
            </button>
            <button 
              type="submit"
              className="flex-1 px-4 py-2.5 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-thin transition-all shadow-lg shadow-blue-500/20 active:scale-95"
            >
              Unlock
            </button>
          </div>
        </form>
      </Modal>

      {/* Add/Edit Modal */}
      <Modal 
        isOpen={isAddModalOpen || isEditModalOpen} 
        onClose={closeModals}
        title={isDesignMode ? "Design Studio" : (isEditModalOpen ? "Edit Album" : "Add Album")}
      >
        <form onSubmit={handleSave} className="space-y-6 h-full flex flex-col">
           
           {isDesignMode ? (
             /* --- Design Studio View --- */
             <div className="flex-1 space-y-6 animate-in fade-in duration-300">
                <div className="flex items-center justify-between">
                   <button 
                     type="button"
                     onClick={() => setIsDesignMode(false)} 
                     className="text-xs text-blue-500 hover:text-blue-700 flex items-center gap-1 transition-colors"
                   >
                      <ChevronLeft size={14} /> Back to Details
                   </button>
                </div>

                {/* Preview */}
                <div className="flex justify-center py-2">
                   <div className="w-48 h-48 relative transform-style-3d">
                      {/* Vinyl Behind */}
                      <div className="absolute inset-0 z-0 animate-spin-slow rounded-full shadow-xl" style={{ left: '25%' }}>
                         <VinylRecordVisual coverUrl={formData.coverUrl} vinylUrl={formData.vinylUrl} isSpinning={false} color={formData.vinylColor} />
                      </div>
                      {/* Cover Front */}
                      <div className="absolute inset-0 z-10 shadow-xl rounded-sm overflow-hidden bg-white">
                         <img 
                           src={formData.coverUrl || "https://placehold.co/400x400/f3f4f6/9ca3af?text=No+Cover"} 
                           alt="Cover" 
                           className="w-full h-full object-cover"
                         />
                         <div className="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent pointer-events-none"></div>
                      </div>
                   </div>
                </div>

                {/* Design Controls */}
                <div className="space-y-4">
                   
                   {/* Cover Upload */}
                   <div className="space-y-2">
                      <label className="block text-xs font-thin text-gray-500 uppercase tracking-wide mb-1">Cover Art</label>
                      <div 
                          className={`relative w-full h-24 bg-gray-50 rounded-lg border-2 border-dashed ${dragActiveField === 'coverUrl' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-blue-400'} transition-colors flex items-center justify-center cursor-pointer group overflow-hidden`}
                          onDragEnter={(e) => handleDrag(e, 'coverUrl')}
                          onDragLeave={(e) => handleDrag(e, 'coverUrl')}
                          onDragOver={(e) => handleDrag(e, 'coverUrl')}
                          onDrop={(e) => handleDrop(e, 'coverUrl')}
                      >
                          <div className="text-center p-2 flex flex-col items-center">
                            <ImageIcon size={20} className="text-gray-300 mb-1 group-hover:text-blue-400 transition-colors" />
                            <span className="text-[10px] text-gray-400 font-thin">
                                {dragActiveField === 'coverUrl' ? 'Drop Here' : 'Drag & Drop or Click'}
                            </span>
                          </div>
                          <input 
                            type="file" 
                            accept="image/*" 
                            className="absolute inset-0 opacity-0 cursor-pointer"
                            onChange={(e) => handleFileChange(e, 'coverUrl')}
                          />
                      </div>
                   </div>

                   {/* Vinyl Color & Pattern */}
                   <div className="space-y-2">
                      <label className="block text-xs font-thin text-gray-500 uppercase tracking-wide mb-1 flex justify-between">
                        <span>Vinyl Color & Pattern</span>
                        {isProcessingVinyl && <span className="text-blue-500 flex items-center gap-1"><Loader2 size={10} className="animate-spin"/> Nano Banana AI Processing...</span>}
                      </label>
                      <div className="flex gap-3 flex-wrap">
                         {/* Clear Option */}
                         <button
                             type="button"
                             onClick={() => setFormData({...formData, vinylColor: 'transparent', vinylUrl: ''})}
                             className={`w-8 h-8 rounded-full border-2 border-gray-200 shadow-sm transition-transform hover:scale-110 flex items-center justify-center bg-gray-50 ${formData.vinylColor === 'transparent' && !formData.vinylUrl ? 'border-blue-500 scale-110' : ''}`}
                             title="Clear / Transparent"
                           >
                             <Droplet size={14} className="text-gray-400" />
                         </button>

                         {['#111111', '#d32f2f', '#1976d2', '#388e3c', '#fbc02d', '#7b1fa2', '#e0e0e0'].map(color => (
                           <button
                             key={color}
                             type="button"
                             onClick={() => handleSolidColorGeneration(color)} 
                             className={`w-8 h-8 rounded-full border-2 shadow-sm transition-transform hover:scale-110 ${formData.vinylColor === color && !formData.vinylUrl ? 'border-blue-500 scale-110' : 'border-transparent'}`}
                             style={{ backgroundColor: color }}
                           />
                         ))}
                         <div className="relative w-8 h-8 rounded-full overflow-hidden border-2 border-gray-200 shadow-sm group">
                            <input 
                              type="color" 
                              value={formData.vinylColor === 'transparent' ? '#ffffff' : formData.vinylColor}
                              onChange={(e) => handleSolidColorGeneration(e.target.value)}
                              className="absolute inset-[-50%] w-[200%] h-[200%] cursor-pointer p-0 border-0"
                            />
                            <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                               <Palette size={14} className="text-gray-500" />
                            </div>
                         </div>
                         {/* Pattern Upload Button (Nano Banana) */}
                         <div className="relative w-8 h-8 rounded-full border-2 border-dashed border-gray-300 hover:border-blue-400 shadow-sm group bg-gray-50 cursor-pointer flex items-center justify-center overflow-hidden"
                              title="Upload Pattern (Nano Banana AI)">
                            <input 
                              type="file" 
                              accept="image/*"
                              onChange={handlePatternUpload}
                              className="absolute inset-0 opacity-0 cursor-pointer z-10"
                            />
                            <Zap size={14} className={`text-gray-400 group-hover:text-blue-500 ${formData.vinylUrl ? 'text-yellow-500 fill-yellow-500' : ''}`} />
                         </div>
                      </div>
                   </div>
                </div>
             </div>
           ) : (
             /* --- Details View --- */
             <div className="flex-1 space-y-6">
               <div className="space-y-2">
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-xs font-thin text-gray-500 mb-1.5 uppercase tracking-wide">Artist</label>
                      <input 
                        type="text" 
                        required
                        value={formData.artist}
                        onChange={(e) => setFormData({...formData, artist: e.target.value})}
                        className="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all placeholder:text-gray-400 font-thin"
                        placeholder="e.g. Michael Jackson"
                      />
                    </div>
                    <div>
                      <label className="block text-xs font-thin text-gray-500 mb-1.5 uppercase tracking-wide">Album Title</label>
                      <input 
                        type="text" 
                        required
                        value={formData.title}
                        onChange={(e) => setFormData({...formData, title: e.target.value})}
                        className="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all placeholder:text-gray-400 font-thin"
                        placeholder="e.g. Thriller"
                      />
                    </div>
                  </div>
                  
                  {/* Auto-fill Button */}
                  <button 
                    type="button"
                    onClick={searchiTunesMetadata}
                    disabled={isFetching || !formData.artist || !formData.title}
                    className="w-full py-2 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg text-xs font-thin transition-colors flex items-center justify-center gap-2 disabled:opacity-50 mt-4"
                  >
                    {isFetching ? <Loader2 size={14} className="animate-spin" /> : <Wand2 size={14} />}
                    Auto-fill Details from iTunes
                  </button>
               </div>

               {/* Design Button */}
               <div className="pt-2">
                  <button 
                    type="button"
                    onClick={() => setIsDesignMode(true)}
                    className="w-full py-3 bg-gradient-to-r from-blue-50 to-indigo-50 hover:from-blue-100 hover:to-indigo-100 border border-blue-100 text-blue-700 rounded-lg text-sm font-normal transition-all flex items-center justify-center gap-2 group"
                  >
                    <Palette size={16} className="group-hover:scale-110 transition-transform" />
                    Design Vinyl & Cover
                  </button>
                  <p className="text-[10px] text-center text-gray-400 mt-2 font-thin">Customize vinyl color and upload custom artwork</p>
               </div>
             </div>
           )}

           {/* Footer Actions */}
           <div className="pt-2 border-t border-gray-50 flex items-center justify-between gap-3 mt-auto">
             {isEditModalOpen && !isDesignMode && (
               <button 
                type="button"
                onClick={handleDelete}
                className="flex items-center justify-center px-4 py-2.5 bg-red-50 hover:bg-red-100 text-red-600 rounded-lg font-thin transition-colors"
               >
                 <Trash2 size={18} className="mr-2" />
                 Delete
               </button>
             )}
             
             <div className="flex items-center gap-3 ml-auto w-full justify-end">
                <button 
                  type="button"
                  onClick={closeModals}
                  className="px-5 py-2.5 text-gray-600 hover:text-gray-900 font-thin transition-colors"
                >
                  Cancel
                </button>
                <button 
                  type="submit"
                  className="flex items-center justify-center px-6 py-2.5 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-thin transition-all active:scale-95 shadow-lg shadow-blue-500/30"
                >
                  <Save size={18} className="mr-2" />
                  Save
                </button>
             </div>
          </div>
        </form>
      </Modal>

      <style>{`
        /* Apple System Font Stack */
        .apple-font {
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
          font-weight: 100; /* Ultra Thin / Thin */
        }
        
        .perspective-container {
          perspective: 1000px;
        }
        .transform-style-3d {
          transform-style: preserve-3d;
        }
        
        /* Custom scrollbar to match clean aesthetic */
        ::-webkit-scrollbar {
          width: 0px; /* Hide scrollbar for cleaner look */
        }

        @keyframes spin-slow {
          from {
            transform: rotate(0deg);
          }
          to {
            transform: rotate(360deg);
          }
        }
        .animate-spin-slow {
          animation: spin-slow 8s linear infinite;
        }
      `}</style>
    </div>
  );
}